# üöÄ Testes Evolution API - Documenta√ß√£o Completa

## üìã Vis√£o Geral

Esta documenta√ß√£o descreve a infraestrutura completa de testes para a integra√ß√£o WhatsApp Evolution API no sistema SPR Backend.

### ‚úÖ Scripts Dispon√≠veis

| Script | Fun√ß√£o | Uso |
|--------|--------|-----|
| `evo_test.sh` | Testes principais Evolution API | `./scripts/evo_test.sh <comando>` |
| `monitor_dashboard.sh` | Dashboard de monitoramento | `./scripts/monitor_dashboard.sh` |
| `setup_evolution_env.sh` | Configura√ß√£o do ambiente | `./scripts/setup_evolution_env.sh <comando>` |

---

## üß™ Script Principal: evo_test.sh

### Comandos Dispon√≠veis

```bash
# Verificar pr√©-requisitos
./scripts/evo_test.sh check

# Testar health checks
./scripts/evo_test.sh health  

# Criar inst√¢ncia WhatsApp
./scripts/evo_test.sh create [nome_instancia]

# Obter QR Code para conex√£o
./scripts/evo_test.sh qr [nome_instancia]

# Conectar inst√¢ncia (mostra QR)
./scripts/evo_test.sh connect [nome_instancia]

# Enviar mensagem teste
./scripts/evo_test.sh send [instancia] [numero] [mensagem]

# Monitoramento em tempo real
./scripts/evo_test.sh monitor

# Suite completa de testes
./scripts/evo_test.sh test
```

### Exemplos Pr√°ticos

```bash
# 1. Verificar se tudo est√° funcionando
./scripts/evo_test.sh check

# 2. Criar nova inst√¢ncia
./scripts/evo_test.sh create minha_empresa

# 3. Obter QR Code para conectar
./scripts/evo_test.sh qr minha_empresa

# 4. Enviar mensagem teste
./scripts/evo_test.sh send minha_empresa +5511999887766 "Ol√°! Teste da API"

# 5. Executar todos os testes
./scripts/evo_test.sh test
```

### Sa√≠das Esperadas

#### ‚úÖ Teste com Sucesso
```
[STEP] Verificando pr√©-requisitos
[SUCCESS] Backend SPR est√° dispon√≠vel
[SUCCESS] Evolution API est√° dispon√≠vel
[SUCCESS] Pr√©-requisitos verificados

[STEP] Testando health checks
[SUCCESS] Backend health: ok
[SUCCESS] WhatsApp health: service=whatsapp, ok=true
[SUCCESS] Health checks completados
```

#### ‚ùå Problemas Comuns
```
[ERROR] Backend SPR n√£o est√° dispon√≠vel em http://localhost:3002
[INFO] Execute: node spr-backend-complete.js

[ERROR] Evolution API n√£o est√° dispon√≠vel em http://localhost:8080
[WARNING] Alguns testes ser√£o limitados
```

---

## üìä Dashboard de Monitoramento

O `monitor_dashboard.sh` fornece uma vis√£o em tempo real de todos os servi√ßos.

### Como Usar
```bash
./scripts/monitor_dashboard.sh
```

### Informa√ß√µes Exibidas
- ‚úÖ Status dos servi√ßos principais
- ‚è±Ô∏è Uptime do backend
- üì± Contagem de inst√¢ncias WhatsApp
- üíª M√©tricas do sistema (CPU, RAM, Disco)
- üîó Status dos endpoints
- üìù Atividade recente

### Exemplo de Sa√≠da
```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë               üöÄ SPR MONITORING DASHBOARD                    ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

SERVI√áOS PRINCIPAIS:
  Backend SPR:         üü¢ ONLINE
  Evolution API:       üü¢ ONLINE  
  WhatsApp Service:    üü¢ ONLINE

M√âTRICAS:
  Backend Uptime:      2h 45m
  Inst√¢ncias WA:       3 inst√¢ncias
  Sistema:             CPU: 15.2% | RAM: 68.1% | Disco: 45%

ENDPOINTS:
  /health                    üü¢ ONLINE
  /api/status               üü¢ ONLINE
  /api/offers               üü¢ ONLINE
  /api/whatsapp/health      üü¢ ONLINE
```

---

## ‚öôÔ∏è Configura√ß√£o do Ambiente

O script `setup_evolution_env.sh` automatiza a configura√ß√£o inicial.

### Comandos Dispon√≠veis
```bash
# Configura√ß√£o inicial completa
./scripts/setup_evolution_env.sh init

# Configurar apenas Evolution API
./scripts/setup_evolution_env.sh config

# Testar configura√ß√µes
./scripts/setup_evolution_env.sh test

# Mostrar configura√ß√µes atuais
./scripts/setup_evolution_env.sh show

# Recriar arquivo .env
./scripts/setup_evolution_env.sh reset
```

### Configura√ß√£o Inicial
```bash
./scripts/setup_evolution_env.sh init
```

O script ir√°:
1. ‚úÖ Criar arquivo `.env` com configura√ß√µes padr√£o
2. ‚úÖ Solicitar URL e API Key da Evolution API
3. ‚úÖ Criar scripts auxiliares
4. ‚úÖ Testar todas as configura√ß√µes
5. ‚úÖ Mostrar resumo final

### Arquivo .env Gerado
```bash
# EVOLUTION API - WHATSAPP
EVO_URL=http://localhost:8080
EVOLUTION_API_URL=http://localhost:8080
EVO_APIKEY=sua-api-key-aqui
EVOLUTION_API_KEY=sua-api-key-aqui
EVO_WEBHOOK_TOKEN=seu-webhook-token
EVOLUTION_WEBHOOK_TOKEN=seu-webhook-token

# SPR BACKEND
PORT=3002
NODE_ENV=development
SPR_MTR_SERVICE_URL=http://localhost:3001/mtr/detect
```

---

## üîß Pr√©-requisitos

### Software Necess√°rio
- ‚úÖ `curl` - Para requisi√ß√µes HTTP
- ‚úÖ `bash` - Shell script execution
- ‚ö†Ô∏è `jq` - Para parsing JSON (opcional, script funciona sem)

### Servi√ßos Necess√°rios
- ‚úÖ **Backend SPR** rodando em `localhost:3002`
- ‚úÖ **Evolution API** configurada (URL e API Key)
- ‚ö†Ô∏è **Evolution API Server** rodando (opcional para alguns testes)

### Verifica√ß√£o R√°pida
```bash
# Verificar se backend est√° rodando
curl http://localhost:3002/health

# Verificar se Evolution API est√° acess√≠vel  
curl http://localhost:8080

# Executar verifica√ß√£o completa
./scripts/evo_test.sh check
```

---

## üì± Fluxo de Teste Completo

### 1. Prepara√ß√£o do Ambiente
```bash
# 1.1. Configurar ambiente (primeira vez)
./scripts/setup_evolution_env.sh init

# 1.2. Verificar pr√©-requisitos
./scripts/evo_test.sh check
```

### 2. Testes de Conectividade
```bash
# 2.1. Testar health checks
./scripts/evo_test.sh health

# 2.2. Executar suite completa
./scripts/evo_test.sh test
```

### 3. Cria√ß√£o e Teste de Inst√¢ncia
```bash
# 3.1. Criar nova inst√¢ncia
./scripts/evo_test.sh create teste_spr

# 3.2. Obter QR Code
./scripts/evo_test.sh qr teste_spr

# 3.3. Conectar WhatsApp (escaneie o QR Code)
# Aguardar conex√£o ser estabelecida

# 3.4. Enviar mensagem teste
./scripts/evo_test.sh send teste_spr +5511999887766 "ü§ñ Teste SPR Evolution API"
```

### 4. Monitoramento Cont√≠nuo
```bash
# Dashboard em tempo real
./scripts/monitor_dashboard.sh
```

---

## üêõ Diagn√≥stico e Resolu√ß√£o de Problemas

### Problema: Backend n√£o est√° dispon√≠vel
```bash
[ERROR] Backend SPR n√£o est√° dispon√≠vel em http://localhost:3002
```

**Solu√ß√£o:**
```bash
# Verificar se o processo est√° rodando
ps aux | grep node

# Iniciar backend se necess√°rio
node spr-backend-complete.js
```

### Problema: Evolution API n√£o configurada
```bash
[WARNING] Evolution API n√£o est√° dispon√≠vel em http://localhost:8080
```

**Solu√ß√£o:**
```bash
# 1. Verificar configura√ß√£o
./scripts/setup_evolution_env.sh show

# 2. Reconfigurar se necess√°rio
./scripts/setup_evolution_env.sh config

# 3. Testar nova configura√ß√£o
./scripts/setup_evolution_env.sh test
```

### Problema: Falha na cria√ß√£o de inst√¢ncia
```bash
[ERROR] Falha ao criar inst√¢ncia 'minha_instancia'
```

**Poss√≠veis causas:**
1. ‚ùå API Key inv√°lida
2. ‚ùå Evolution API n√£o est√° rodando
3. ‚ùå Nome da inst√¢ncia j√° existe

**Solu√ß√µes:**
```bash
# Verificar logs detalhados
curl -v -X POST http://localhost:3002/api/whatsapp/instance \
  -H "Content-Type: application/json" \
  -d '{"instanceName":"teste_debug"}'

# Verificar Evolution API diretamente
curl -H "apikey: $EVO_APIKEY" http://localhost:8080/instance/fetchInstances
```

### Problema: Mensagem n√£o √© enviada
```bash
[ERROR] Falha ao enviar mensagem
```

**Verifica√ß√µes:**
1. ‚úÖ Inst√¢ncia est√° conectada ao WhatsApp?
2. ‚úÖ N√∫mero est√° no formato correto? (+5511999887766)
3. ‚úÖ WhatsApp Web est√° funcionando na inst√¢ncia?

---

## üìà M√©tricas e Monitoramento

### Health Check Endpoints

| Endpoint | Fun√ß√£o | Resposta Esperada |
|----------|--------|-------------------|
| `/health` | Status geral do backend | `{"status": "ok"}` |
| `/api/whatsapp/health` | Status do WhatsApp service | `{"ok": true, "service": "whatsapp"}` |
| `/api/status` | M√©tricas detalhadas | Status completo dos servi√ßos |

### C√≥digos de Status HTTP

| C√≥digo | Significado | A√ß√£o |
|--------|-------------|------|
| 200 | ‚úÖ Sucesso | Continuar opera√ß√£o |
| 400 | ‚ùå Erro de requisi√ß√£o | Verificar par√¢metros |
| 401 | ‚ùå N√£o autorizado | Verificar API Key |
| 500 | ‚ùå Erro interno | Verificar logs do servidor |
| Timeout | ‚ùå Sem resposta | Verificar conectividade |

---

## üîÑ Integra√ß√£o Cont√≠nua

### Testes Automatizados
```bash
#!/bin/bash
# Script para CI/CD

# 1. Verificar ambiente
./scripts/evo_test.sh check || exit 1

# 2. Executar testes
./scripts/evo_test.sh health || exit 1

# 3. Testar cria√ß√£o de inst√¢ncia (se Evolution API dispon√≠vel)
if [ -n "$EVO_APIKEY" ]; then
    ./scripts/evo_test.sh create ci_test_$(date +%s)
fi

echo "‚úÖ Todos os testes passaram"
```

### Monitoramento em Produ√ß√£o
```bash
# Cron job para monitoramento (executar a cada 5 minutos)
*/5 * * * * /path/to/scripts/evo_test.sh health >> /var/log/spr-health.log 2>&1
```

---

## üìö Refer√™ncias T√©cnicas

### Estrutura de Resposta da API
```json
{
  "success": true,
  "data": {
    "instanceName": "minha_instancia",
    "qrcode": "data:image/png;base64,..."
  },
  "timestamp": "2025-09-05T18:53:00.000Z"
}
```

### Vari√°veis de Ambiente
```bash
# URLs
BACKEND_URL=http://localhost:3002    # URL do backend SPR
EVO_URL=http://localhost:8080        # URL da Evolution API

# Autentica√ß√£o
EVO_APIKEY=sua-api-key-aqui         # API Key da Evolution API
EVO_WEBHOOK_TOKEN=webhook-token      # Token para webhooks

# Configura√ß√µes de teste
DEFAULT_INSTANCE=spr_test_instance   # Nome padr√£o para inst√¢ncia
DEFAULT_TEST_NUMBER=+5511999887766   # N√∫mero para testes
```

---

## ‚ú® Pr√≥ximos Passos

### Melhorias Planejadas
- [ ] Suporte a m√∫ltiplas inst√¢ncias simult√¢neas
- [ ] Dashboard web em tempo real  
- [ ] Integra√ß√£o com Grafana/Prometheus
- [ ] Testes automatizados de regress√£o
- [ ] Notifica√ß√µes por email/Slack em falhas

### Comandos Avan√ßados (Em Desenvolvimento)
```bash
# Backup e restore de inst√¢ncias
./scripts/evo_test.sh backup [instancia]
./scripts/evo_test.sh restore [instancia]

# M√©tricas detalhadas
./scripts/evo_test.sh metrics

# Limpeza de inst√¢ncias antigas
./scripts/evo_test.sh cleanup
```

---

## üìû Suporte

Para problemas ou d√∫vidas:

1. üîç Verificar esta documenta√ß√£o
2. üß™ Executar `./scripts/evo_test.sh test` para diagn√≥stico
3. üìä Usar `./scripts/monitor_dashboard.sh` para monitoramento
4. üìù Verificar logs em `/tmp/spr_*.log`

---

**‚úÖ Infraestrutura de testes Evolution API configurada e pronta para uso!**