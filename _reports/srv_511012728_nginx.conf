total 12
drwxr-xr-x  2 root root 4096 Sep  3 11:21 .
drwxr-xr-x 10 root root 4096 Sep  2 13:50 ..
lrwxrwxrwx  1 root root   57 Sep  2 14:00 spr.conf -> /etc/nginx/sites-available/spr_performance_optimized.conf
-rw-r--r--  1 root root  764 Sep  2 13:59 spr.conf.backup-20250902_125943
lrwxrwxrwx  1 root root   40 Sep  2 12:39 spr_test.conf -> /etc/nginx/sites-available/spr_test.conf
# SPR Configuration with Rewrites/Proxy (no redirects)

# HTTP server para IP apenas
server {
  listen 80;
  server_name 138.197.83.3 royalnegociosagricolas.com.br www.royalnegociosagricolas.com.br;
  
  # Frontend estático
  root /var/www/spr;
  index index.html;

  # API Rewrites - Replace 308 redirects with internal rewrites
  
  # CRITICAL: URL Normalization - Fix api/api/* duplication
  location ~ ^/api/api/(.*)$ {
    rewrite ^/api/api/(.*)$ /api/$1 last;
  }
  
  # Legacy aliases for offer-management  
  location ~ ^/api/offer-management(.*)$ {
    rewrite ^/api/offer-management(.*)$ /api/ofertas_negocios/ofertas$1 last;
  }
  
  # Legacy aliases for commodities dashboard
  location ~ ^/api/commodities/dashboard/summary(.*)$ {
    rewrite ^/api/commodities/dashboard/summary(.*)$ /api/dados-mercado$1 last;
  }
  
  # System endpoints mapping to existing services
  location ~ ^/api/system/status(.*)$ {
    rewrite ^/api/system/status(.*)$ /api/health$1 last;
  }
  
  location ~ ^/api/system/monitoring(.*)$ {
    rewrite ^/api/system/monitoring(.*)$ /api/system/monitor$1 last;
  }
  
  location ~ ^/api/system/health(.*)$ {
    rewrite ^/api/system/health(.*)$ /api/health$1 last;
  }
  
  # Ofertas rewrites - Evitar loop infinito com ofertas_negocios
  location ~ ^/api/ofertas(?!_negocios)(.*)$ {
    rewrite ^/api/ofertas(.*)$ /api/ofertas_negocios/ofertas$1 last;
  }
  
  location ~ ^/api/negocios(?!.*ofertas_negocios)(.*)$ {
    rewrite ^/api/negocios(.*)$ /api/ofertas_negocios/negocios$1 last;
  }
  
  location ~ ^/api/acompanhamentos(?!.*ofertas_negocios)(.*)$ {
    rewrite ^/api/acompanhamentos(.*)$ /api/ofertas_negocios/acompanhamentos$1 last;
  }
  
  # Market data rewrites
  location ~ ^/api/market-data(.*)$ {
    rewrite ^/api/market-data(.*)$ /api/dados-mercado$1 last;
  }

  # Socket.IO WebSocket proxy
  location /socket.io/ {
    proxy_pass http://127.0.0.1:3002;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # CORS for WebSocket
    add_header 'Access-Control-Allow-Origin' "$http_origin" always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;
    
    # WebSocket timeouts
    proxy_connect_timeout 7d;
    proxy_send_timeout 7d;
    proxy_read_timeout 7d;
    
    # Disable buffering for real-time communication
    proxy_buffering off;
    proxy_cache off;
  }

  # SPR Master Coordinator proxy
  location /coordinator/ {
    # Tratamento de preflight OPTIONS
    if ($request_method = OPTIONS) {
      add_header 'Access-Control-Allow-Origin' "$http_origin" always;
      add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS' always;
      add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Accept, Origin, X-Agent-Secret, X-Coordinator' always;
      add_header 'Access-Control-Allow-Credentials' 'true' always;
      add_header 'Access-Control-Max-Age' 3600 always;
      return 204;
    }
    
    # CORS para requisições normais  
    add_header 'Access-Control-Allow-Origin' "$http_origin" always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;
    add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
