<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste React SSH - Diagn√≥stico</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background-color: #25d366;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .test-section {
            background-color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #cce7ff; color: #004085; border: 1px solid #b8daff; }
        iframe {
            width: 100%;
            height: 600px;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        .console-output {
            background-color: #222;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Diagn√≥stico React SSH</h1>
        <p>Sistema de teste para identificar problema SSH no React</p>
    </div>

    <div class="test-section">
        <h2>üåê Teste de Conectividade do Servidor</h2>
        <div id="server-status" class="status info">Testando...</div>
        <button onclick="testServerConnection()">üîÑ Testar Novamente</button>
    </div>

    <div class="test-section">
        <h2>üì± Aplica√ß√£o React - Frame Isolado</h2>
        <p>Carregando aplica√ß√£o React em iframe para capturar erros:</p>
        <iframe src="http://localhost:3002" id="react-iframe"></iframe>
        
        <div class="console-output" id="console-output">
            <div>Console de erros JavaScript:</div>
            <div>Aguardando carregamento...</div>
        </div>
    </div>

    <div class="test-section">
        <h2>üîç Detalhes do Navegador</h2>
        <div id="browser-info"></div>
    </div>

    <div class="test-section">
        <h2>üìã Log de Testes</h2>
        <div id="test-log" class="console-output"></div>
    </div>

    <script>
        // Capturar erros da aplica√ß√£o React
        let errorLog = [];
        let originalConsoleError = console.error;
        let originalConsoleWarn = console.warn;
        
        console.error = function(...args) {
            errorLog.push({type: 'error', message: args.join(' '), timestamp: new Date().toISOString()});
            updateConsoleOutput();
            originalConsoleError.apply(console, args);
        };
        
        console.warn = function(...args) {
            errorLog.push({type: 'warn', message: args.join(' '), timestamp: new Date().toISOString()});
            updateConsoleOutput();
            originalConsoleWarn.apply(console, args);
        };

        // Capturar erros n√£o tratados
        window.addEventListener('error', function(e) {
            errorLog.push({
                type: 'error',
                message: `Error: ${e.message} in ${e.filename}:${e.lineno}`,
                timestamp: new Date().toISOString()
            });
            updateConsoleOutput();
        });

        // Capturar promises rejeitadas
        window.addEventListener('unhandledrejection', function(e) {
            errorLog.push({
                type: 'error',
                message: `Unhandled Promise Rejection: ${e.reason}`,
                timestamp: new Date().toISOString()
            });
            updateConsoleOutput();
        });

        function updateConsoleOutput() {
            const output = document.getElementById('console-output');
            const sshErrors = errorLog.filter(log => 
                log.message.toLowerCase().includes('ssh') || 
                log.message.toLowerCase().includes('authentication')
            );
            
            let html = '<div>Console de erros JavaScript:</div>';
            
            if (sshErrors.length > 0) {
                html += '<div style="color: #ff4444;"><strong>‚ùå ERROS SSH DETECTADOS:</strong></div>';
                sshErrors.forEach(log => {
                    html += `<div style="color: #ff4444;">[${log.timestamp}] ${log.type.toUpperCase()}: ${log.message}</div>`;
                });
            } else if (errorLog.length > 0) {
                html += '<div style="color: #ffaa44;"><strong>‚ö†Ô∏è Outros erros detectados:</strong></div>';
                errorLog.slice(-10).forEach(log => {
                    const color = log.type === 'error' ? '#ff4444' : '#ffaa44';
                    html += `<div style="color: ${color};">[${log.timestamp}] ${log.type.toUpperCase()}: ${log.message}</div>`;
                });
            } else {
                html += '<div style="color: #44ff44;">‚úÖ Nenhum erro detectado ainda...</div>';
            }
            
            output.innerHTML = html;
            output.scrollTop = output.scrollHeight;
        }

        async function testServerConnection() {
            const statusDiv = document.getElementById('server-status');
            statusDiv.className = 'status info';
            statusDiv.textContent = '‚è≥ Testando conex√£o...';
            
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                statusDiv.className = 'status success';
                statusDiv.innerHTML = `‚úÖ Servidor conectado com sucesso!<br>
                                     Status: ${data.status}<br>
                                     Uptime: ${Math.floor(data.uptime)}s<br>
                                     Vers√£o: ${data.version}`;
                logTest('Conex√£o com servidor: ‚úÖ OK');
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `‚ùå Erro na conex√£o: ${error.message}`;
                logTest(`Conex√£o com servidor: ‚ùå ERRO - ${error.message}`);
            }
        }

        function logTest(message) {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toISOString();
            logDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Informa√ß√µes do navegador
        function displayBrowserInfo() {
            const info = document.getElementById('browser-info');
            info.innerHTML = `
                <strong>User Agent:</strong> ${navigator.userAgent}<br>
                <strong>Plataforma:</strong> ${navigator.platform}<br>
                <strong>Linguagem:</strong> ${navigator.language}<br>
                <strong>Online:</strong> ${navigator.onLine ? '‚úÖ' : '‚ùå'}<br>
                <strong>URL Atual:</strong> ${window.location.href}
            `;
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            displayBrowserInfo();
            testServerConnection();
            logTest('P√°gina de diagn√≥stico carregada');
            
            // Monitorar iframe
            const iframe = document.getElementById('react-iframe');
            iframe.onload = function() {
                logTest('React App carregado no iframe');
                
                // Tentar acessar o conte√∫do do iframe para capturar erros
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    logTest('Acesso ao iframe: ‚úÖ OK');
                } catch (error) {
                    logTest(`Acesso ao iframe: ‚ùå ERRO - ${error.message}`);
                }
            };
            
            iframe.onerror = function(error) {
                logTest(`Erro no iframe: ${error.message || error}`);
            };
        });

        // Atualizar console de output periodicamente
        setInterval(updateConsoleOutput, 1000);
    </script>
</body>
</html>